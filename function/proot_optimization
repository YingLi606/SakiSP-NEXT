RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
PINK='\e[1;35m'
RES='\e[0m'
ERROR="[${RED}é”™è¯¯${RES}]:"
WORRY="[${YELLOW}è­¦å‘Š${RES}]:"
SUSSEC="[${GREEN}æˆåŠŸ${RES}]:"
INFO="[${BLUE}ä¿¡æ¯${RES}]:"
Modify_the_variable() {
    sed -i "s/^${1}=.*/${1}=${2}/" ${3}
}
get_linux_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    elif [ -f /etc/issue ]; then
        local issue_content=$(cat /etc/issue | awk '{print $1; exit}')
        echo "$issue_content" | tr '[:upper:]' '[:lower:]'
    else
        echo "unknown"
    fi
}
detect_package_manager() {
    local distro=$(get_linux_distro)
    case "$distro" in
        "ubuntu"|"debian"|"linuxmint"|"pop"|"kali")
            echo "apt"
            ;;
        "centos"|"rhel"|"rocky"|"almalinux")
            echo "yum"
            ;;
        "fedora")
            echo "dnf"
            ;;
        "archarm"|"manjaro"|"endeavouros")
            echo "pacman"
            ;;
        "opensuse"|"suse")
            echo "zypper"
            ;;
        *)
            if command -v apt >/dev/null 2>&1; then
                echo "apt"
            elif command -v dnf >/dev/null 2>&1; then
                echo "dnf"
            elif command -v yum >/dev/null 2>&1; then
                echo "yum"
            elif command -v pacman >/dev/null 2>&1; then
                echo "pacman"
            elif command -v zypper >/dev/null 2>&1; then
                echo "zypper"
            elif [ -d "/data/data/com.termux/files/usr" ]; then
                echo "pkg"
                return
            else
                echo "unknown"
                return 1
            fi
            ;;
    esac
}
package_manager=$(detect_package_manager)
current_distro=$(get_linux_distro)
self_install() {
    local pkg_manager=$1
    local pkg_name=$2
    if ! command -v "$pkg_name" &>/dev/null; then
        echo -e "${RED}æœªå®‰è£… $pkg_nameï¼Œæ­£åœ¨å®‰è£…...${RES}"
        if [ "$pkg_manager" = "pacman" ]; then
            $pkg_manager -S --noconfirm "$pkg_name"
        else
            $pkg_manager install -y "$pkg_name"
        fi
    fi
}
hcjx() {
    echo -e "${GREEN}æŒ‰å›è½¦é”®ç»§ç»­...${RES}"
    read -r
}
echo -e "${INFO}æ­£åœ¨ä¼˜åŒ–ç³»ç»Ÿï¼Œè¯·å‹¿é€€å‡ºï¼${RES}"
echo "127.0.0.1 localhost" >/etc/hosts
mkdir -p /run/systemd/resolve
echo -e "${GREEN}æ­£åœ¨ä¿®å¤DNS${RES}"

echo -e "nameserver 8.8.8.8
nameserver 114.114.114.114" >/run/systemd/resolve/stub-resolv.conf

echo -e "nameserver 8.8.8.8
nameserver 114.114.114.114" >/etc/resolv.conf
echo -e "${GREEN}å°è¯•ç¦ç”¨æ— ç”¨æ£€æµ‹${RES}"
ln -s ~/SakiSP-NEXT/sakispnext.sh /usr/bin/sakispnext 2>/dev/null
chmod 777 /usr/bin/sakispnext 2>/dev/null
touch ~/.hushlogin

whiptail_available=0
if [ "$current_distro" = "ubuntu" ] || [ "$current_distro" = "debian" ] || [ "$current_distro" = "kali" ]; then
    echo -e "${INFO}æ£€æµ‹åˆ°æ”¯æŒ whiptail çš„ç³»ç»Ÿï¼ˆ$current_distroï¼‰ï¼Œæ­£åœ¨æ£€æŸ¥æ˜¯å¦å·²å®‰è£…...${RES}"
    if command -v whiptail >/dev/null 2>&1; then
        whiptail_available=1
        echo -e "${SUSSEC}whiptail å·²å®‰è£…${RES}"
    else
        echo -e "${WORRY}whiptail æœªå®‰è£…ï¼Œæ­£åœ¨å¼€å§‹å®‰è£…...${RES}"
        self_install $package_manager whiptail
        if command -v whiptail >/dev/null 2>&1; then
            whiptail_available=1
            echo -e "${SUSSEC}whiptail å®‰è£…å®Œæˆ${RES}"
        else
            echo -e "${ERROR}whiptail å®‰è£…å¤±è´¥${RES}"
        fi
    fi
elif [ "$current_distro" = "archarm" ] || [ "$current_distro" = "manjaro" ] || [ "$current_distro" = "endeavouros" ]; then
    echo -e "${GREEN}æ‰§è¡Œç³»ç»Ÿæ›´æ–°${RES}"
    pacman -Syu --noconfirm
    echo -e "${INFO}ç³»ç»Ÿæ›´æ–°å®Œæˆï¼Œæ­£åœ¨å®‰è£…ç›¸å…³ä¾èµ–...${RES}"
    pacman -S --noconfirm libnewt adobe-source-han-serif-cn-fonts wqy-zenhei wget git jq curl bc sudo vim
    echo -e "${SUSSEC}ç»§ç»­åç»­æ­¥éª¤${RES}"
    echo -e "${INFO}æ­£åœ¨é…ç½®Archç³»ç»Ÿä¸­æ–‡ç¯å¢ƒ...${RES}"
    sed -i 's/^#zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
    locale-gen
    echo "LANG=zh_CN.UTF-8" >/etc/locale.conf
    echo -e "${SUSSEC}ä¸­æ–‡ç¯å¢ƒé…ç½®å®Œæˆ${RES}"
    if command -v whiptail >/dev/null 2>&1; then
        whiptail_available=1
    else
        echo -e "${WORRY}whiptail å®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡SakiSPå®‰è£…è¯¢é—®${RES}"
    fi
else
    echo -e "${WORRY}å½“å‰ç³»ç»Ÿï¼ˆ$current_distroï¼‰ä¸æ”¯æŒ whiptailï¼Œå°†è·³è¿‡ SakiSP å®‰è£…æ­¥éª¤${RES}"
    whiptail_available=0
fi


if [ "$current_distro" != "archarm" ] && [ "$current_distro" != "manjaro" ] && [ "$current_distro" != "endeavouros" ]; then
    if [ "$current_distro" = "ubuntu" ] || [ "$current_distro" = "debian" ] || [ "$current_distro" = "kali" ] || [ "$current_distro" = "centos" ] || [ "$current_distro" = "rocky" ]; then
        echo -e "${INFO}æ­£åœ¨å®‰è£…å¯¹åº”ä¾èµ–...${RES}"
        self_install $package_manager language-pack-zh-hans
        self_install $package_manager fonts-wqy-microhei
        self_install $package_manager fonts-wqy-zenhei
        self_install $package_manager glibc-langpack-zh
        self_install $package_manager xfonts-wqy
        self_install $package_manager ttf-wqy-zenhei
        self_install $package_manager wget
        self_install $package_manager git
        self_install $package_manager jq
        self_install $package_manager curl
        self_install $package_manager bc
    fi
fi

echo -e "${INFO}å‡†å¤‡æ£€æµ‹ç³»ç»Ÿå‘è¡Œç‰ˆ${RES}"
sleep 2
if [ -f /etc/os-release ] && [ "$current_distro" != "archarm" ] && [ "$current_distro" != "manjaro" ] && [ "$current_distro" != "endeavouros" ]; then
    . /etc/os-release
    case $ID in
        ubuntu|debian|kali)
            echo -e "${SUSSEC} æ£€æµ‹åˆ°æ”¯æŒçš„ç³»ç»Ÿï¼š$PRETTY_NAMEï¼Œè¯·è‡ªè¡Œé…ç½®è¯­è¨€${RES}"
            hcjx
            dpkg-reconfigure locales
            echo -e "${SUSSEC} è¯­è¨€é…ç½®å®Œæˆï¼Œ2ç§’åç»§ç»­...${RES}"
            sleep 2
            clear
            echo -e "${INFO} æ¥ä¸‹æ¥è¯·è‡ªè¡Œé…ç½®æ—¶åŒº ${RES}"
            hcjx
            dpkg-reconfigure tzdata
            echo -e "${SUSSEC} æ—¶åŒºé…ç½®å®Œæˆï¼Œ2ç§’åç»§ç»­...${RES}"
            sleep 2
            clear
            ;;
        *)
            echo -e "${ERROR} æ£€æµ‹åˆ°ä¸æ”¯æŒçš„ç³»ç»Ÿï¼š$PRETTY_NAMEï¼Œè·³è¿‡è¯­è¨€é…ç½®åŠæ—¶åŒºæ­¥éª¤${RES}"
            sleep 2
            clear
            ;;
    esac
elif [ "$current_distro" != "archarm" ] && [ "$current_distro" != "manjaro" ] && [ "$current_distro" != "endeavouros" ]; then
    echo -e "${ERROR} æ— æ³•æ£€æµ‹ç³»ç»Ÿå‘è¡Œç‰ˆï¼Œè·³è¿‡è¯­è¨€é…ç½®æ­¥éª¤${RES}"
    sleep 2
    clear
fi

if [ $whiptail_available -eq 1 ]; then
    whiptail --title "å®‰è£…SakiSP" --yesno "æ˜¯å¦éœ€è¦å®‰è£…SakiSPï¼Ÿè¯¥å·¥å…·å¯ç”¨äºå¾ˆå¤§ç”¨é€”" 10 60
    if [ $? -eq 0 ]; then
        clear
        echo -e "${INFO} ç”¨æˆ·é€‰æ‹©å®‰è£…SakiSPï¼Œæ­£åœ¨å…‹éš†ä»“åº“...${RES}"
        git clone https://gh.xmly.dev/https://github.com/YingLi606/SakiSP.git 2>/dev/null
        sleep 2
        echo -e "${SUSSEC} SakiSPå·²å®Œæˆå®‰è£…æ­¥éª¤ï¼Œå¦‚éœ€ä½¿ç”¨è¯·è¾“å…¥bash ~/SakiSP/sakisp.shï¼Œå³å°†è¿›å…¥ä¸‹ä¸€æ­¥...${RES}"
        sleep 2
    else
        echo -e "${INFO} ç”¨æˆ·é€‰æ‹©æ— éœ€å®‰è£…SakiSPï¼Œè¯¥æ­¥éª¤è·³è¿‡${RES}"
    fi
fi

clear
echo -e "${INFO}ç°åœ¨ï¼Œè¯·é€‰æ‹©ä½ éœ€è¦æ›´æ¢çš„å›½å†…è½¯ä»¶æº${RES}"
sleep 3
sudo bash -c "bash <(curl -sSL https://linuxmirrors.cn/main.sh)" && echo -e "${GREEN}âœ… è½¯ä»¶æºåˆ‡æ¢æ‰§è¡Œå®Œæˆï¼Œæ­£åœ¨è¿›å…¥ä¸‹ä¸€æ­¥...${RES}"
sleep 2
clear
sleep 0.1
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "  ğŸ“¦  TMOE TOOL å®‰è£…å‘å¯¼  ğŸ“¦              "
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "  âœ…  å»ºè®®å›½å†…ç”¨æˆ·é€‰æ‹© Gitee æº           "
echo -e "  âœ…  å®‰è£…è¿‡ç¨‹ä¸­å»ºè®®å…¨ç¨‹è¾“å…¥ Y ç¡®è®¤       "
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "\nâ“ æ˜¯å¦éœ€è¦å®‰è£… TMOE TOOLï¼Ÿ${RES}"
echo -e "ğŸ“Œ è¯·è¾“å…¥ï¼š(y/n)"
read -r user_choice
if [[ "$user_choice" =~ ^[Yy]$ ]]; then
    clear
    echo -e "\n${INFO}ğŸš€ ç”¨æˆ·é€‰æ‹©å®‰è£…ï¼Œæ­£åœ¨å‡†å¤‡å¯åŠ¨å®‰è£…ç¨‹åº...${RES}"
    sleep 2
    sudo bash -c "$(curl -L https://gitee.com/mo2/linux/raw/2/2)"
    sleep 2
    clear
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "  âœ…  TMOE TOOL å®‰è£…å®Œæˆï¼                "
    echo -e "  ğŸ“¢  è¯·é‡æ–°å¯åŠ¨è„šæœ¬å¹¶å¯åŠ¨å®¹å™¨           "
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    sleep 3
else
    clear
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "  â­ï¸  ç”¨æˆ·é€‰æ‹©è·³è¿‡ TMOE TOOL å®‰è£…         "
    echo -e "  ğŸ“¢  è¯·é‡æ–°å¯åŠ¨è„šæœ¬å¹¶å¯åŠ¨å®¹å™¨           "
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    sleep 3
fi
exit
