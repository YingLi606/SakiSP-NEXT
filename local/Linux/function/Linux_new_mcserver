#!/bin/bash
RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
PINK='\e[1;35m'
RES='\e[0m'

ERROR="[${RED}ÈîôËØØ${RES}]:"
WORRY="[${YELLOW}Ë≠¶Âëä${RES}]:"
SUSSEC="[${GREEN}ÊàêÂäü${RES}]:"
INFO="[${BLUE}‰ø°ÊÅØ${RES}]:"

BASE_DIR="$HOME/.termux/SakiSP-NEXT/MCserver"  

check_commands() {
    echo -e "${INFO} Ê≠£Âú®Ê£ÄÊü•ÂøÖË¶ÅÂëΩ‰ª§....${RES}"
    local cmds=("whiptail" "wget" "java" "find" "chmod" "rm")
    for cmd in "${cmds[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            echo -e "${ERROR} Áº∫Â∞ëÂëΩ‰ª§ $cmdÔºåËØ∑ÂÆâË£ÖÂêéÈáçËØïÔºÅ${RES}"
            sleep 3 && clear && exit 1
        fi
    done
    [ ! -d "$BASE_DIR" ] && { mkdir -p "$BASE_DIR"; chmod 755 "$BASE_DIR"; }
}

check_system() {
    check_commands
    if ! command -v lsb_release &> /dev/null; then
        echo -e "${ERROR} Êó†lsb_releaseÔºåÊó†Ê≥ïËØÜÂà´Á≥ªÁªüÔºÅ${RES}"
        sleep 5 && clear && exit 1
    fi
    OS=$(lsb_release -is)
    SUPPORTED=("Ubuntu" "Kali" "Debian" "GXDE" "Deepin" "UOS")
    [[ ! " ${SUPPORTED[@]} " =~ " ${OS} " ]] && {
        echo -e "${ERROR} Á≥ªÁªü${OS}Êú™ÈÄÇÈÖçÔºå‰ªÖÊîØÊåÅ${SUPPORTED[*]}ÔºÅ${RES}"
        sleep 5 && clear && exit 1
    }
    echo -e "${SUSSEC} ÈÄÇÈÖçÁ≥ªÁªüÔºö${OS}${RES}"
}

check_java() {
    echo -e "${INFO} Ê£ÄÊü•Java 21...${RES}"
    if command -v java &> /dev/null && java -version 2>&1 | grep -q "21"; then
        echo -e "${GREEN}[ÊàêÂäü] Java 21Â∑≤ÂÆâË£Ö${RES}"
        sleep 2 && clear
    else
        echo -e "${WORRY} Ê£ÄÊµãÂà∞ÊÇ®ÂÆâË£ÖÁöÑÂèØËÉΩ‰∏çÊòØJava 21,Ê≠£Âú®ÂÆâË£ÖJava 21...${RES}"
        apt update &> /dev/null && apt install openjdk-21-jre -y &> /dev/null
        if ! java -version 2>&1 | grep -q "21"; then
            echo -e "${ERROR} Java 21ÂÆâË£ÖÂ§±Ë¥•ÔºÅËØ∑Ê£ÄÊü•‰Ω†ÁöÑÁΩëÁªúÁéØÂ¢ÉÊàñ‰æùËµñÔºåÂ¶ÇÊûúÊúâÂêåÊ†∑ÈîôËØØÔºåËØ∑ÂèäÊó∂ËÅîÁ≥ªÂºÄÂèëËÄÖÔºÅ${RES}"
            sleep 5 && clear && exit 1
        fi
    fi
}

install_core() {
    local CORE_JAR="" INSTALL_DIR="" CORE_TYPE="" VERSION="" MEM_MIN="" MEM_MAX=""
    CORE=$(whiptail --title "ÈÄâÊúçÂä°Á´ØÁ±ªÂûã" --menu "ËØ∑ÈÄâÊã©Ë¶ÅÂÆâË£ÖÁöÑÊúçÂä°Á´Ø" 15 50 4 \
        "1" "Paper" "2" "Spigot" "3" "Nukkit" "4" "Fabric" \
        3>&1 1>&2 2>&3)
    [ -z "$CORE" ] && return

    case $CORE in
        1)
            CORE_TYPE="Paper"
            VER=$(whiptail --title "ÈÄâPaperÁâàÊú¨" --menu "ÈÄâÊã©ÁâàÊú¨" 12 40 2 \
                "1" "1.21.10" "2" "1.21.8" \
                3>&1 1>&2 2>&3)
            [ -z "$VER" ] && return
            VERSION=$([ $VER -eq 1 ] && echo "1.21.10" || echo "1.21.8")
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="paper.jar"
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            clear
            echo -e "${INFO} ÂºÄÂßã‰∏ãËΩΩPaper $VERSION Ê†∏ÂøÉ...${RES}"
            if [ "$VERSION" = "1.21.10" ]; then
                wget --show-progress "https://fill-data.papermc.io/v1/objects/23f6560d17e285149c0e486579e3fcc8208dcc171a59c4d021057a9063534732/paper-1.21.10-64.jar" -O "$CORE_JAR"
            else
                wget --show-progress "https://fill-data.papermc.io/v1/objects/8de7c52c3b02403503d16fac58003f1efef7dd7a0256786843927fa92ee57f1e/paper-1.21.8-60.jar" -O "$CORE_JAR"
            fi
            ;;
        2)
            CORE_TYPE="Spigot"
            VER=$(whiptail --title "ÈÄâSpigotÁâàÊú¨" --menu "ÈÄâÊã©ÁâàÊú¨" 10 40 1 \
                "1" "1.21.8" \
                3>&1 1>&2 2>&3)
            [ -z "$VER" ] && return
            VERSION="1.21.8"
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="spigot.jar"
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            clear
            echo -e "${INFO} ÂºÄÂßã‰∏ãËΩΩSpigot $VERSION Ê†∏ÂøÉ...${RES}"
            wget --show-progress "https://cdn.getbukkit.org/spigot/spigot-1.21.8.jar" -O "$CORE_JAR"
            ;;
        3)
            CORE_TYPE="Nukkit"
            VER=$(whiptail --title "ÈÄâNukkitÁâàÊú¨" --menu "ÈÄâÊã©ÁâàÊú¨" 10 40 1 \
                "1" "build1120" \
                3>&1 1>&2 2>&3)
            [ -z "$VER" ] && return
            VERSION="build1120"
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="nukkit.jar"
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            echo -e "${INFO} ÂºÄÂßã‰∏ãËΩΩNukkit $VERSION Ê†∏ÂøÉ...${RES}"
            wget --show-progress "https://download.fastmirror.net/download/NukkitX/general/build1120" -O "$CORE_JAR"
            ;;
        4)
            CORE_TYPE="Fabric"
            VER=$(whiptail --title "ÈÄâFabricÁâàÊú¨" --menu "ÈÄâÊã©ÁâàÊú¨" 12 40 2 \
                "1" "1.21.10" "2" "1.21.9" \
                3>&1 1>&2 2>&3)
            [ -z "$VER" ] && return
            VERSION=$([ $VER -eq 1 ] && echo "1.21.10" || echo "1.21.9")
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            echo -e "${INFO} ÂºÄÂßã‰∏ãËΩΩFabric $VERSION Ê†∏ÂøÉ...${RES}"
            # ÂÖ≥ÈîÆ1ÔºöÂà†Èô§-oÂèÇÊï∞Ôºå‰øùÁïôÂéüÂßãÊñá‰ª∂ÂêçÔºàÊ†ºÂºèÔºöfabric-server-mc.ÁâàÊú¨Âè∑-loader.0.17.3-launcher.1.1.0.jarÔºâ
            if [ "$VERSION" = "1.21.10" ]; then
                sudo curl -OJ "https://meta.fabricmc.net/v2/versions/loader/1.21.10/0.17.3/1.1.0/server/jar"
            else
                sudo curl -OJ "https://meta.fabricmc.net/v2/versions/loader/1.21.9/0.17.3/1.1.0/server/jar"
            fi
            # ÂÖ≥ÈîÆ2ÔºöËØªÂèñÁ¨¶ÂêàÊ†ºÂºèÁöÑFabric jarÊñá‰ª∂ÂêçÔºåÈÅøÂÖçÁ°¨ÁºñÁ†Å
            CORE_JAR=$(ls "fabric-server-mc.$VERSION-loader.0.17.3-launcher.1.1.0.jar" 2>/dev/null)
            [ -z "$CORE_JAR" ] && { echo -e "${ERROR} FabricÊ†∏ÂøÉÊñá‰ª∂Êú™ÊâæÂà∞Ôºå‰∏ãËΩΩÂ§±Ë¥•ÔºÅ${RES}"; return; }
            
            echo -e "${INFO} ÂºÄÂßã‰∏ãËΩΩFabric API $VERSION...${RES}"
            if [ "$VERSION" = "1.21.10" ]; then
                wget --show-progress "https://cdn.modrinth.com/data/P7dR8mSH/versions/qNm2IWMn/fabric-api-0.135.0%2B1.21.10.jar" -O plugins/fabric-api.jar
            else
                wget --show-progress "https://cdn.modrinth.com/data/P7dR8mSH/versions/iHrvVvaM/fabric-api-0.134.0%2B1.21.9.jar" -O plugins/fabric-api.jar
            fi
            ;;
    esac
    echo -e "${SUSSEC} $CORE_TYPE-$VERSION ÊúçÂä°Á´ØÊ†∏ÂøÉ‰∏ãËΩΩÂÆåÊàêÔºåË∑ØÂæÑÔºö$INSTALL_DIRÔºåÊ†∏ÂøÉÊñá‰ª∂Ôºö$CORE_JAR${RES}"

    echo -e "${INFO} Á¨¨‰∏ÄÊ≠•ÔºöÈÖçÁΩÆJavaÂèØÊâßË°åÊñá‰ª∂Ë∑ØÂæÑ...${RES}"
    sleep 2
    local java_paths=$(ls /usr/lib/jvm/*/bin/java 2>/dev/null)
    if [ -z "$java_paths" ]; then
        echo -e "${WORRY} Êú™Ê£ÄÊµãÂà∞Á≥ªÁªüÈªòËÆ§JavaË∑ØÂæÑÔºåËØ∑ÊâãÂä®ËæìÂÖ•ÂÆåÊï¥Ë∑ØÂæÑ${RES}"
        java_paths="Êó†ÈªòËÆ§JavaË∑ØÂæÑ"
    fi
    read -e -p "ËØ∑ËæìÂÖ•JavaÂèØÊâßË°åÊñá‰ª∂Ë∑ØÂæÑÔºàÂ∑≤ÂÆâË£ÖË∑ØÂæÑÂèÇËÄÉÔºö
$java_paths
Ôºâ:" wherejava
    if [ ! -x "$wherejava" ]; then
        echo -e "${WORRY} ËæìÂÖ•Ë∑ØÂæÑÊó†ÊïàÔºåËá™Âä®ÂàáÊç¢‰∏∫Á≥ªÁªüÈªòËÆ§JavaÂëΩ‰ª§${RES}"
        wherejava="java"
    fi

    echo -e "${INFO} Á¨¨‰∫åÊ≠•ÔºöÈÖçÁΩÆÊúçÂä°Âô®ÂÜÖÂ≠òÂèÇÊï∞...${RES}"
    sleep 2
    if [ "$CORE_TYPE" = "Fabric" ]; then
        MEM_MIN=$(whiptail --title "ÈÖçÁΩÆFabricÊúÄÂ∞èÂÜÖÂ≠ò(-Xms)" --inputbox "ËØ∑ËæìÂÖ•FabricÊúÄÂ∞èÂÜÖÂ≠òÔºàÊ†ºÂºèÔºö1G/2GÔºåÈªòËÆ§2GÔºâ" 10 50 "2G" 3>&1 1>&2 2>&3)
        [[ ! "$MEM_MIN" =~ [Gg]$ ]] && MEM_MIN="${MEM_MIN}G"
        MEM_MAX=$(whiptail --title "ÈÖçÁΩÆFabricÊúÄÂ§ßÂÜÖÂ≠ò(-Xmx)" --inputbox "ËØ∑ËæìÂÖ•FabricÊúÄÂ§ßÂÜÖÂ≠òÔºàÊ†ºÂºèÔºö2G/4GÔºåÈªòËÆ§2GÔºâ" 10 50 "2G" 3>&1 1>&2 2>&3)
        [[ ! "$MEM_MAX" =~ [Gg]$ ]] && MEM_MAX="${MEM_MAX}G"
    else
        MEM_MIN=$(whiptail --title "ÈÖçÁΩÆÊúÄÂ∞èÂÜÖÂ≠ò(-Xms)" --inputbox "ËØ∑ËæìÂÖ•ÊúÄÂ∞èÂÜÖÂ≠òÔºàÊ†ºÂºèÔºö1G/2GÔºåÈªòËÆ§2GÔºâ" 10 50 "2G" 3>&1 1>&2 2>&3)
        [[ ! "$MEM_MIN" =~ [Gg]$ ]] && MEM_MIN="${MEM_MIN}G"
        MEM_MAX=$(whiptail --title "ÈÖçÁΩÆÊúÄÂ§ßÂÜÖÂ≠ò(-Xmx)" --inputbox "ËØ∑ËæìÂÖ•ÊúÄÂ§ßÂÜÖÂ≠òÔºàÊ†ºÂºèÔºö2G/4GÔºåÈªòËÆ§2GÔºâ" 10 50 "2G" 3>&1 1>&2 2>&3)
        [[ ! "$MEM_MAX" =~ [Gg]$ ]] && MEM_MAX="${MEM_MAX}G"
    fi
    echo -e "${WORRY} Â∑≤ËÆæÁΩÆÂÜÖÂ≠òÂèÇÊï∞Ôºö-Xms$MEM_MIN -Xmx$MEM_MAX${RES}"

    local full_jar_path="$INSTALL_DIR/$CORE_JAR"
    local full_eula_path="$INSTALL_DIR/eula.txt"
    # ÂÖ≥ÈîÆ3Ôºöstart.sh‰∏≠‰ΩøÁî®ÂÆûÈôÖËØªÂèñÁöÑCORE_JARÊñá‰ª∂ÂêçÔºå‰∏çÁ°¨ÁºñÁ†Å
    cat > "$INSTALL_DIR/start.sh" << EOF
#!/bin/bash
cd "$INSTALL_DIR"
echo -e "eula=true" > "$full_eula_path"
$wherejava -Xms$MEM_MIN -Xmx$MEM_MAX -jar "$full_jar_path" nogui
EOF
    chmod +x "$INSTALL_DIR/start.sh"
    echo -e "${SUSSEC} ÂêØÂä®ËÑöÊú¨ÁîüÊàêÂÆåÊàêÔºåËÑöÊú¨‰∏≠Ê†∏ÂøÉË∑ØÂæÑÔºö$full_jar_path${RES}"

    echo -e "${INFO} $CORE_TYPE-$VERSION ÊúçÂä°Á´ØÂêØÂä®‰∏≠ÔºàÂÜÖÂ≠òÔºö$MEM_MIN/$MEM_MAXÔºâ...${RES}"
    bash "$INSTALL_DIR/start.sh"
    [ $? -ne 0 ] && echo -e "${ERROR} ÂêØÂä®Â§±Ë¥•ÔºåÂèØÊâãÂä®ÊâßË°å $INSTALL_DIR/start.sh Êü•ÁúãÊó•ÂøóÊéíÊü•${RES}" && sleep 3
}

plugin_store() {
    local CORE_TYPE_LIST=()
    local TARGET_CORES=("Paper" "Spigot" "Fabric")
    for CORE in "${TARGET_CORES[@]}"; do
        [ -d "$BASE_DIR/$CORE" ] && CORE_TYPE_LIST+=("$CORE" "${CORE} ÊúçÂä°Á´Ø")
    done
    [ ${#CORE_TYPE_LIST[@]} -eq 0 ] && {
        echo -e "${ERROR} $BASE_DIR ‰∏ãÊó†Â∑≤ÂÆâË£ÖÁöÑPaper/Spigot/FabricÊúçÂä°Á´ØÔºÅ${RES}"
        sleep 3 && clear && return
    }

    SELECTED_CORE=$(whiptail --title "ÈÄâÊã©ÊúçÂä°Á´ØÁ±ªÂûã" --menu "Â∑≤ÂÆâË£ÖÊúçÂä°Á´ØÁ±ªÂûã" 15 50 3 "${CORE_TYPE_LIST[@]}" 3>&1 1>&2 2>&3)
    [ -z "$SELECTED_CORE" ] && return

    local VER_LIST=()
    local CORE_PATH="$BASE_DIR/$SELECTED_CORE"
    for VER_DIR in "$CORE_PATH"/1.21.*; do
        [ -d "$VER_DIR" ] || continue
        local VER_NAME=$(basename "$VER_DIR")
        if [ -d "$VER_DIR/plugins" ]; then
            VER_LIST+=("$VER_DIR" "${SELECTED_CORE}-${VER_NAME}")
        else
            echo -e "${WORRY} ${SELECTED_CORE}-${VER_NAME} Êó†pluginsÊñá‰ª∂Â§πÔºå‰∏çÂèØ‰∏ãËΩΩÊèí‰ª∂${RES}"
        fi
    done
    [ ${#VER_LIST[@]} -eq 0 ] && {
        echo -e "${ERROR} ${SELECTED_CORE} ‰∏ãÊó†Â∏¶pluginsÊñá‰ª∂Â§πÁöÑ1.21.xÁâàÊú¨ÔºÅ${RES}"
        sleep 3 && return
    }

    SELECTED_VER_DIR=$(whiptail --title "ÈÄâÊã©Ë∑ØÂæÑ" --menu "${SELECTED_CORE} ÂèØ‰∏ãËΩΩÊèí‰ª∂ÁöÑÁâàÊú¨" 20 60 10 "${VER_LIST[@]}" 3>&1 1>&2 2>&3)
    [ -z "$SELECTED_VER_DIR" ] && return
    local PLUGIN_DIR="$SELECTED_VER_DIR/plugins"

    echo -e "${INFO} ÂºÄÂßã‰∏ãËΩΩ ${SELECTED_CORE} ÁâàGeyser...${RES}"
    if [ "$SELECTED_CORE" = "Fabric" ]; then
        wget --show-progress "https://download.geysermc.org/v2/projects/geyser/versions/2.8.4/builds/947/downloads/fabric" -O "$PLUGIN_DIR/Geyser-Fabric.jar"
    else
        wget --show-progress "https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/spigot" -O "$PLUGIN_DIR/Geyser-Spigot.jar"
    fi

    [ $? -eq 0 ] && echo -e "${SUSSEC} GeyserÊèí‰ª∂Â∑≤‰∏ãËΩΩËá≥Ôºö$PLUGIN_DIR${RES}" || echo -e "${ERROR} GeyserÊèí‰ª∂‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØïÔºÅ${RES}"
    sleep 3
}

INSTALL_MC_SERVER_NEW() {
    check_system
    check_java
    while true; do
        MAIN_MENU=$(whiptail --title "MCÊúçÂä°Âô®ÁÆ°ÁêÜÔºàÊñ∞Ôºâ" --menu "ÁÆ°ÁêÜÊúçÂä°Âô®ËØ∑‰ªéÊóßÁâàÊìç‰ΩúÔºåË∞¢Ë∞¢" 15 50 3 \
            "1" "üì¶ ÂÆâË£ÖÊúçÂä°Âô®Ê†∏ÂøÉ" "2" "üì• Êèí‰ª∂ÂïÜÂ∫ó" "3" "üåö ÈÄÄÂá∫" \
            3>&1 1>&2 2>&3)
        case $MAIN_MENU in
            1) install_core ;;
            2) plugin_store ;;
            3)
                echo -e "${INFO} 3ÁßíÂêéÈÄÄÂá∫...${RES}"
                sleep 3 && clear && exit 0
                ;;
            *) clear && exit 0 ;;
        esac
    done
}

[[ "${BASH_SOURCE[0]}" == "$0" ]] && INSTALL_MC_SERVER_NEW
